# Backtest Configuration v6 - PRODUCTION FROZEN 2025-12-20
# FLAT v1.0 - Single source of truth

# ============================================================
# SLIPPAGE & COMMISSIONS
# ============================================================

slippage:
  per_leg: 0.02

commissions:
  per_contract: 0.65
  min_per_order: 0.00
  reg_fee_per_contract: 0.02

# ============================================================
# STRATEGY: SKEW EXTREME
# ============================================================
# STEEP = is_steep=1, credit PUT spread
# FLAT = is_flat=1, debit CALL spread

strategies:
  skew_extreme:
    enable_credit_spread: true   # STEEP
    enable_debit_spread: true    # FLAT
    
    # ============================================================
    # PRODUCTION UNIVERSE (17+1 symbols) - LOCKED
    # ============================================================
    # Tier-1 (17): Statistically validated, regime-filter compatible
    # Tier-1.5 (1): XLV only - defensive sector, mean-reverting skew
    #
    # DO NOT ADD: SMH, SOXX, XLB, TIP, IJR, IWF, IWB, IWD, IWP
    # Reason: Negative expectancy under IVpâ‰¤75 gate
    enabled_symbols: ["SPY", "QQQ", "IWM", "DIA", "XLF", "XLE", "XLK", "XLI", "XLY", "XLP", "XLU", "TLT", "IEF", "GLD", "SLV", "USO", "EEM", "XLV"]
    disabled_symbols: []
    
    # Signal thresholds
    min_strength: 0.50
    
    # Credit quality gate
    min_credit_to_width: 0.20
    
    # Mean-reversion gating
    require_skew_reverting: true
    skew_delta_window: 5
    min_delta: 0.005
    min_percentile_change: 10

  # ============================================================
  # STRATEGY: TERM STRUCTURE MEAN-REVERSION (v1)
  # ============================================================
  # Orthogonal to FLAT - trades front-vs-back IV dislocation
  
  term_structure_mr:
    # FLAT Tier-1 only (17 symbols) - XLV excluded until Phase-1 validated
    enabled_symbols: ["SPY", "QQQ", "IWM", "DIA", "XLF", "XLE", "XLK", "XLI", "XLY", "XLP", "XLU", "TLT", "IEF", "GLD", "SLV", "USO", "EEM"]
    
    # DTE ranges for front/back comparison
    front_dte_range: [20, 35]
    back_dte_range: [60, 90]
    
    # Z-score configuration
    z_threshold: 2.0
    lookback_days: 120
    min_history_days: 60
    
    # Width cascade
    width_cascade: [5, 10]

# ============================================================
# REGIME GATE - Config-driven (mandatory for FLAT)
# ============================================================

regime_gate:
  flat:
    max_atm_iv_pctl: 75   # Optimal from IV sweep (PF 2.15)
  steep:
    max_atm_iv_pctl: null  # Not yet validated
  term_structure_mr:
    max_atm_iv_pctl: 85
    max_vix: 30

# ============================================================
# FLAT v1.0 DOCUMENTATION
# ============================================================
# LOCKED 2025-12-20
#
# Performance (17 Tier-1 symbols, IVpâ‰¤75):
#   22 trades, 77% WR, PF 2+, Max DD 4.4%
#
# Regime Bands:
#   ðŸŸ¢ IVp â‰¤ 75: Trade (aggressive)
#   ðŸŸ¡ 75 < IVp â‰¤ 80: Cautious
#   ðŸ”´ IVp > 80: Do not trade

# ============================================================
# PHASE PRESETS
# ============================================================

phases:
  phase1:
    description: "Edge Existence Validation"
    portfolio_mode: signal_quality
    min_credit_to_width: 0.15
    risk_engine_enabled: false
  
  phase2:
    description: "Tradeability"
    portfolio_mode: portfolio_safe
    min_credit_to_width: 0.20
    risk_engine_enabled: true
  
  phase3:
    description: "Optimization"
    portfolio_mode: portfolio_safe
    min_credit_to_width: 0.20
    risk_engine_enabled: true

# ============================================================
# RISK ENGINE
# ============================================================

risk_engine:
  # Equity-based sizing (default for production)
  initial_equity: 25000        # $25k account â†’ 2% = $500/trade
  risk_per_trade_pct: 0.02     # 2% risk per trade
  risk_per_trade_usd: 500      # Fallback if pct is null
  max_total_risk_pct: 0.06     # 6% total portfolio risk (3 Ã— 2%)
  max_total_risk_usd: 1500     # Fallback if pct is null
  max_open_positions: 3
  
  clusters:
    equity_etf: [SPY, QQQ, IWM]
  max_cluster_risk_usd: 1000
  max_cluster_positions: 2     # Tested: 3 adds 0 trades (dedup is the bottleneck)
  cluster_dedup_mode: best_edge
  cluster_risk_multiplier: 0.5
  
  dd_kill_pct: 0.10
  symbol_cooldown_after_sl_days: 10
  cluster_cooldown_after_sl_days: 5

# ============================================================
# WIDTH SELECTION
# ============================================================

width_selection:
  cascade: [5, 10]
  max_risk_per_trade: 500
  min_volume: 10
  min_open_interest: 100
  max_bid_ask_pct: 10.0

# ============================================================
# EXIT RULES - SINGLE SOURCE
# ============================================================

exit_rules:
  credit_spread:
    take_profit_pct: null
    stop_loss_mult: null
    time_stop_dte: 7

  debit_spread:
    take_profit_pct: 70
    stop_loss_pct: null
    time_stop_dte: 7
    early_exit:
      enabled: false

# ============================================================
# EXECUTION
# ============================================================

execution:
  next_day_execution: true
  fill_model: "close_plus_slippage"

# ============================================================
# DEFAULTS
# ============================================================

defaults:
  lookback_days: 90
  trade_only: true
  symbols: ["SPY", "QQQ", "IWM", "DIA", "XLF", "XLE", "XLK", "XLI", "XLY", "XLP", "XLU", "TLT", "IEF", "GLD", "SLV", "USO", "EEM", "XLV"]

# ============================================================
# VALIDATION
# ============================================================

validation:
  min_coverage: 0.90
  fail_on_low_coverage: true
  max_fallback_strike_distance_points: 5
  max_fallback_trade_ratio: 0.25
  allow_fallback_strikes: true

# ============================================================
# DATA SOURCE
# ============================================================

data:
  options_history_provider: flatfiles
