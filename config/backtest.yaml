# Backtest Configuration v4
# Research-correct: width cascade, mean-reversion gating, proper exits

# ============================================================
# SLIPPAGE & COMMISSIONS
# ============================================================

slippage:
  per_leg: 0.02

commissions:
  per_contract: 0.65
  min_per_order: 0.00
  reg_fee_per_contract: 0.02

# ============================================================
# STRATEGY TOGGLES
# ============================================================

strategies:
  skew_extreme:
    enable_credit_spread: true
    enable_debit_spread: false  # Disabled until proven
    enabled_symbols: ["SPY", "QQQ", "IWM"]
    disabled_symbols: ["TLT"]
    min_strength: 0.50
    
    # Credit quality gate (reject steamroller trades)
    min_credit_to_width: 0.20   # Credit must be >= 20% of width
    
    # Mean-reversion gating
    require_skew_reverting: true
    skew_delta_window: 5        # 5-day lookback
    min_delta: 0.005            # 0.5 vol point minimum move (was 0.01)
    min_percentile_change: 10   # OR 10 percentile points
    
    # Regime filter
    blocked_regimes: ["HIGH_VOL_PANIC", "TREND_DOWN"]
    
    # Position limits
    max_positions_per_symbol: 1
    cooldown_after_sl_days: 10  # Pause after stop-loss
    
    # Cooldown after loss (legacy)
    loss_cooldown_days: 5

# ============================================================
# WIDTH SELECTION
# ============================================================

width_selection:
  # Must be multiples of 5 for SPY/QQQ/IWM strike increments
  cascade: [5, 10]
  
  # Risk cap per trade (max loss in dollars)
  max_risk_per_trade: 500  # $5 width = ~$500 max
  
  # Liquidity requirements
  min_volume: 10
  min_open_interest: 100
  max_bid_ask_pct: 10.0

# ============================================================
# EXIT RULES - PRIORITY ORDER
# ============================================================

exit_rules:
  credit_spread:
    # Exit priority: TP > SL > time_stop
    take_profit_pct: 50       # 50% of credit captured
    stop_loss_mult: 1.25      # 1.25x credit (tightened from 1.5)
    time_stop_dte: 7          # Secondary, after TP/SL checked
    
  debit_spread:
    take_profit_pct: 50
    stop_loss_pct: 50
    time_stop_dte: 10

# ============================================================
# EXECUTION MODEL
# ============================================================

execution:
  next_day_execution: true    # Signal day N, execute day N+1
  fill_model: "close_plus_slippage"

# ============================================================
# DEFAULTS
# ============================================================

defaults:
  lookback_days: 90
  min_edge_strength: 0.50
  trade_only: true
  symbols: ["SPY", "QQQ", "IWM"]

# ============================================================
# V4 OUTPUT DIRECTORY
# ============================================================

output:
  reports_dir: "./logs/backfill/v4/reports"
