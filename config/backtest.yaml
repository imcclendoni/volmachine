# Backtest Configuration v4
# Research-correct: width cascade, mean-reversion gating, proper exits

# ============================================================
# SLIPPAGE & COMMISSIONS
# ============================================================

slippage:
  per_leg: 0.02

commissions:
  per_contract: 0.65
  min_per_order: 0.00
  reg_fee_per_contract: 0.02

# ============================================================
# STRATEGY TOGGLES
# ============================================================

strategies:
  skew_extreme:
    enable_credit_spread: true
    enable_debit_spread: false  # Disabled until proven
    enabled_symbols: ["SPY", "QQQ", "IWM"]
    disabled_symbols: ["TLT"]
    min_strength: 0.50
    
    # Mean-reversion gating
    require_skew_reverting: true
    skew_delta_window: 5        # 5-day lookback
    min_delta: 0.01             # 1 vol point minimum move
    min_percentile_change: 10   # OR 10 percentile points
    
    # Regime filter
    blocked_regimes: ["HIGH_VOL_PANIC", "TREND_DOWN"]
    
    # Cooldown after loss
    loss_cooldown_days: 5

# ============================================================
# WIDTH SELECTION (cascade)
# ============================================================

width_selection:
  # Try widths in order, select first that passes:
  # - contracts exist at strike increment
  # - liquidity filters pass
  # - risk cap met
  cascade: [1, 2, 3, 5]
  
  # Risk cap per trade (max loss in dollars)
  max_risk_per_trade: 100
  
  # Liquidity requirements
  min_volume: 10
  min_open_interest: 100
  max_bid_ask_pct: 10.0

# ============================================================
# EXIT RULES - PRIORITY ORDER
# ============================================================

exit_rules:
  credit_spread:
    # Exit priority (first condition wins)
    exit_priority: ["take_profit", "stop_loss", "skew_norm", "time_stop", "expiry"]
    
    # 1. Take profit: 50-70% of credit captured
    take_profit_pct: 50
    
    # 2. Stop loss: 1.5-2x credit
    stop_loss_mult: 1.5
    
    # 3. Skew normalization: exit when percentile returns to normal
    skew_norm_low: 40
    skew_norm_high: 60
    
    # 4. Time stop: only if none of above (secondary)
    time_stop_dte: 7
    
    # 5. Expiry: last resort
    
  debit_spread:
    exit_priority: ["take_profit", "stop_loss", "skew_norm", "time_stop", "expiry"]
    take_profit_pct: 50
    stop_loss_pct: 50
    skew_norm_low: 40
    skew_norm_high: 60
    time_stop_dte: 10

# ============================================================
# EXECUTION MODEL
# ============================================================

execution:
  # Avoid lookahead bias: signal on day N, execute day N+1
  next_day_execution: true
  
  # Fill model
  fill_model: "close_plus_slippage"  # or "bid_ask"

# ============================================================
# DEFAULTS
# ============================================================

defaults:
  lookback_days: 90
  min_edge_strength: 0.50
  trade_only: true
  symbols: ["SPY", "QQQ", "IWM", "TLT"]

# ============================================================
# VALIDATION
# ============================================================

validation:
  require_history_mode: true
  min_history_days: 20
  fail_on_fallback: true
